<nav class="navbar navbar-dark bg-dark shadow-sm">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h1 text-success fw-bold">Performance Tennis</span>
    <button class="btn btn-outline-light" (click)="logout()">
      <i class="bi bi-box-arrow-right me-1"></i> Sair
    </button>
  </div>
</nav>

<div class="container mt-4">
  
  <h2 class="mb-4 text-secondary">Dashboard de Estatísticas</h2>

  <div *ngIf="stats$ | async as stats" class="row mb-5">
    
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm border-2 border-info rounded-4 p-2 h-100">
        <div class="card-body text-center">
          <p class="card-title text-info fw-bold mb-0">Jogos Totais</p>
          <p class="card-text fs-2 fw-bold mb-0">{{ stats.total }}</p>
        </div>
      </div>
    </div>
    
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm border-2 border-primary rounded-4 p-2 h-100">
        <div class="card-body text-center">
          <p class="card-title text-primary fw-bold mb-0">Vitórias</p>
          <p class="card-text fs-2 fw-bold mb-0">{{ stats.victories }} 
            <span class="text-muted fs-6 fw-normal">({{ stats.victoryRate }}%)</span>
          </p>
        </div>
      </div>
    </div>
    
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm border-2 border-danger rounded-4 p-2 h-100">
        <div class="card-body text-center">
          <p class="card-title text-danger fw-bold mb-0">Derrotas</p>
          <p class="card-text fs-2 fw-bold mb-0">{{ stats.defeats }} 
            <span class="text-muted fs-6 fw-normal">({{ stats.defeatRate }}%)</span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <h2 class="mb-4 text-secondary">Evolução de Desempenho (Mensal)</h2>
  <div class="chart-container mb-5">
    <canvas 
      baseChart
      [data]="lineChartData"
      [options]="lineChartOptions"
      [type]="lineChartType"
    ></canvas>
  </div>
  
  <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
    <h3>Histórico de Partidas</h3>
    <button 
      class="btn btn-success shadow-sm" 
      data-bs-toggle="modal" 
      data-bs-target="#newGameModal"
    >
      <i class="bi bi-plus-circle-fill me-1"></i> Adicionar Jogo
    </button>
  </div>

  <div class="d-flex flex-wrap align-items-center mb-4">
    
    <span class="me-3 fw-bold text-muted">Resultado:</span>
    <button 
      class="btn btn-sm me-2 mb-2" 
      [ngClass]="{'btn-secondary': filterResult === 'Todos', 'btn-outline-secondary': filterResult !== 'Todos'}" 
      (click)="setFilterResult('Todos')">
      Todos
    </button>
    <button 
      class="btn btn-sm me-2 mb-2" 
      [ngClass]="{'btn-primary': filterResult === 'Vitoria', 'btn-outline-primary': filterResult !== 'Vitoria'}" 
      (click)="setFilterResult('Vitoria')">
      Vitórias
    </button>
    <button 
      class="btn btn-sm me-4 mb-2" 
      [ngClass]="{'btn-danger': filterResult === 'Derrota', 'btn-outline-danger': filterResult !== 'Derrota'}" 
      (click)="setFilterResult('Derrota')">
      Derrotas
    </button>

    <span class="me-2 fw-bold text-muted">Ano:</span>
    <select 
      class="form-select form-select-sm me-3 mb-2" 
      style="width: 120px;"
      [ngModel]="selectedFilterYear"
      (ngModelChange)="setFilterYear($event)"
    >
      <option value="Todos">Todos os Anos</option>
      <option *ngFor="let year of availableYears" [ngValue]="year">{{ year }}</option>
    </select>

    <span class="me-2 fw-bold text-muted">Mês:</span>
    <select 
      class="form-select form-select-sm mb-2" 
      style="width: 150px;"
      [ngModel]="selectedFilterMonth"
      (ngModelChange)="setFilterMonth($event)"
    >
      <option *ngFor="let month of monthOptions" [ngValue]="month.value">{{ month.label }}</option>
    </select>

  </div>

  <div *ngIf="games$ | async as games; else loading">
    <div *ngIf="games.length === 0 && filterResult === 'Todos'" class="alert alert-info text-center mt-4">
      Nenhum jogo encontrado. Adicione um para começar!
    </div>
    <div *ngIf="games.length === 0 && filterResult !== 'Todos'" class="alert alert-warning text-center mt-4">
      Nenhum jogo encontrado com os filtros selecionados.
    </div>
    
    <div *ngFor="let game of games" class="card mb-3 shadow-sm border-2 rounded-3"
         [ngClass]="{
           'border-primary': game.result === 'Vitoria',
           'border-danger': game.result === 'Derrota'
         }">
      <div class="card-body">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title fw-bold">
            {{ game.userName }} 
            <span class="text-secondary fw-normal mx-2">vs</span> 
            {{ game.opponentName }}
          </h5>

          <span 
            class="badge py-2 px-3 fs-6"
            [ngClass]="{
              'bg-primary': game.result === 'Vitoria', 
              'bg-danger': game.result === 'Derrota'
            }"
          >
            {{ game.result }}
          </span>
        </div>
        
        <div class="d-flex text-center mb-3 border-top pt-3">
          <div class="col-4 col-md-3 fw-bold text-muted">Jogador</div>
          <div *ngFor="let set of game.sets; let i = index" class="col fw-bold text-muted">
             Set {{ i + 1 }}
          </div>
        </div>

        <div class="d-flex text-center border-bottom pb-2">
          <div class="col-4 col-md-3 fw-bold text-primary">{{ game.userName }}</div>
          <div *ngFor="let set of game.sets" class="col fs-4">{{ set.p1Games }}</div>
        </div>
        
        <div class="d-flex text-center pt-2">
          <div class="col-4 col-md-3 fw-bold text-danger">{{ game.opponentName }}</div>
          <div *ngFor="let set of game.sets" class="col fs-4">{{ set.p2Games }}</div>
        </div>
        
        <p class="text-muted small mt-3 float-start">Data: {{ game.createdAt | date: 'dd/MM/yyyy' }}</p>
        
      </div>
    </div>
  </div>
  
  <ng-template #loading>
    <div class="text-center p-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Carregando jogos...</p>
    </div>
  </ng-template>
</div>


<div class="modal fade" id="newGameModal" tabindex="-1" aria-labelledby="newGameModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="newGameModalLabel">Adicionar Resultado do Jogo</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <form [formGroup]="newGameForm" (ngSubmit)="addNewGame()">
        <div class="modal-body">
          
          <div class="mb-4">
            <label for="opponentName" class="form-label fw-bold">Nome do Adversário</label>
            <input 
              type="text" 
              class="form-control" 
              id="opponentName" 
              formControlName="opponentName"
              placeholder="Ex: Roger Federer"
              required
            >
          </div>
          
          <p class="fw-bold mb-3 border-bottom pb-2">Placar dos Sets (Games Ganhos)</p>
          
          <div class="row mb-3 p-2 border rounded-3 bg-light">
            <h6 class="mb-3">Set 1</h6>
            <div class="col-6">
              <label class="form-label small text-primary">{{ userName$ | async }}</label>
              <input type="number" class="form-control" formControlName="set1P1Games" min="0" max="7">
            </div>
            <div class="col-6">
              <label class="form-label small text-danger">{{ newGameForm.get('opponentName')?.value || 'Adversário' }}</label>
              <input type="number" class="form-control" formControlName="set1P2Games" min="0" max="7">
            </div>
          </div>
          
          <div class="row mb-3 p-2 border rounded-3 bg-light">
            <h6 class="mb-3">Set 2</h6>
            <div class="col-6">
              <label class="form-label small text-primary">{{ userName$ | async }}</label>
              <input type="number" class="form-control" formControlName="set2P1Games" min="0" max="7">
            </div>
            <div class="col-6">
              <label class="form-label small text-danger">{{ newGameForm.get('opponentName')?.value || 'Adversário' }}</label>
              <input type="number" class="form-control" formControlName="set2P2Games" min="0" max="7">
            </div>
          </div>
          
          <div class="row mb-3 p-2 border rounded-3 bg-warning-subtle">
            <h6 class="mb-3">Set 3 (Opcional - Preencher se o jogo foi 1-1)</h6>
            <div class="col-6">
              <label class="form-label small text-primary">{{ userName$ | async }}</label>
              <input type="number" class="form-control" formControlName="set3P1Games" min="0" max="7" placeholder="0">
            </div>
            <div class="col-6">
              <label class="form-label small text-danger">{{ newGameForm.get('opponentName')?.value || 'Adversário' }}</label>
              <input type="number" class="form-control" formControlName="set3P2Games" min="0" max="7" placeholder="0">
            </div>
          </div>
          

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success" [disabled]="newGameForm.invalid" data-bs-dismiss="modal">
            <i class="bi bi-floppy-fill me-1"></i> Salvar Resultado
          </button>
        </div>
      </form>
    </div>
  </div>
</div>